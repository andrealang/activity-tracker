---

copyright:
  years: 2019, 2022
lastupdated: "2021-08-09"

keywords: IBM Cloud, Activity Tracker, security, auditing, getting started

subcollection: activity-tracker

---

{{site.data.keyword.attribute-definition-list}}
 

# Getting started with {{site.data.keyword.atracker_short}} event routing
{: #getting-started-routing}


Use {{site.data.keyword.atracker_short}} to collect auditing events that are generated by services in your {{site.data.keyword.cloud_notm}} account. The events comply with the Cloud Auditing Data Federation (CADF) standard.
{: shortdesc}


This information applies only if you use {{site.data.keyword.atracker_full}} event routing.
{: important}


![The {{site.data.keyword.atracker_full_notm}} service](images/atracker_ov.svg "The {{site.data.keyword.atracker_full_notm}} service")


You can configure {{site.data.keyword.atracker_short}} per region. For each region, you must define a target and a route. 
- A target is a resource where you can collect auditing events. 
- A route defines the rules that determine where auditing events are collected in your account. 

In your account, you can collect [global events](/docs/activity-tracker?topic=activity-tracker-event_types#event_types_global) and [location-based events](/docs/activity-tracker?topic=activity-tracker-event_types#event_types_location). 
- Global events report on activity in your account that relate to data and resources that are generally synchronized across all regions. 
- Location-based events report on activity in your account that is generated by IBM Cloud services that are hosted within an IBM data centre location, like US-South or US-East. 

In your account, you can choose the region where global events are collected.  

To configure {{site.data.keyword.atracker_short}}, you must use the [{{site.data.keyword.atracker_short}} REST API](https://test.cloud.ibm.com/apidocs/atracker){: external}. You can use it with the golang language to define, retrieve, and modify routing targets and routes. 

## Pre-reqs
{: #getting-started-routing-prereqs}

To configure {{site.data.keyword.atracker_short}} in your account, check the following prereqs:

[![Prereq 1. Check your account is VRF enabled.](images/getting-started_prereq1.svg)](#getting-started-routing-prereq-1) [![Prereq 2. Check you have access to private endpoints.](images/getting-started_prereq2.svg)](#getting-started-routing-prereq-2)


### Prereq 1. Check your account is VRF enabled
{: #getting-started-routing-prereq-1}

{{site.data.keyword.atracker_short}} is a feature that requires the account to be virtual routing and forwarding (VRF) enabled.
{: important}

- When using the classic infrastructure, you connect to resources in your account over the {{site.data.keyword.cloud_notm}} public network by default. You can enable virtual routing and forwarding (VRF) to move IP routing for your account and all of its resources into a separate routing table. If VRF is enabled, you can then enable {{site.data.keyword.cloud_notm}} service endpoints to connect directly to resources without using the public network. [Enabling VRF and service endpoints](/docs/account?topic=account-vrf-service-endpoint).

- Virtual Private Clouds (VPCs) are automatically enabled for virtual routing and forwarding (VRF). To enable service endpoints for your VPC, continue to [Enabling service endpoints](/docs/account?topic=account-vrf-service-endpoint#service-endpoint).


To check if the account is VRF enabled, run the following command:

```text
ibmcloud account show
```
{: pre}

To enable private endpoints, run the following command:

```text
ibmcloud account update --service-endpoint-enable true
```
{: pre}



### Prereq 2. Check you have access to private endpoints
{: #getting-started-routing-prereq-2}

{{site.data.keyword.atracker_short}} only supports private endpoints. Therefore, you must configure {{site.data.keyword.atracker_short}} within the private network.

For example, to configure {{site.data.keyword.atracker_short}} in your account, you can provision a VPC VSI. Then, from a terminal, you can run cURL commands to create a target and a route.

Complete the following steps to provision a VPC VSI so that you can run cURL commands to create a target and a route in your account:

1. [Generate an ssh key](/docs/vpc?topic=vpc-ssh-keys).

2. [Create a VSI](https://test.cloud.ibm.com/docs/vpc?topic=vpc-creating-virtual-servers) in your account.

3. [Connect to the VSI](https://test.cloud.ibm.com/docs/vpc?topic=vpc-vsi_is_connecting_linux) from a terminal in your local environment.

4. After you ssh into the VSI, [install the IBM Cloud CLI](https://cloud.ibm.com/docs/cli?topic=cli-install-ibmcloud-cli). Run the following command:

    ```shell
    curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
    ```
    {: pre}

You can run the following command to check that you can access the private endpoints:

```text
ping private.{region}.atracker.cloud.ibm.com
```
{: pre}

For example, you can run the following command to check access to the Dallas region:

```text
ping private.us-south.atracker.cloud.ibm.com
```
{: screen}


## Step 1. Check your IAM permissions to work with {{site.data.keyword.atracker_short}}
{: #getting-started-routing-step1}

**Every user that manages {{site.data.keyword.atracker_short}} configurations in your account must be assigned an access policy.** The policy determines what actions the user can perform. The allowable actions are customized and defined by {{site.data.keyword.atracker_short}} as operations that are allowed to be performed on the service. The actions are then mapped to IAM user roles. [Learn more](/docs/activity-tracker?topic=activity-tracker-iam).

Your user ID needs **account management permissions** to manage {{site.data.keyword.atracker_short}} configurations in the account. You need the **administrator** role. You might need to contact the account administrator to get permissions to work with {{site.data.keyword.atracker_short}}. The account owner can grant another user access to the account for the purposes of managing user access, and managing account resources. [Learn more](/docs/account?topic=account-account-services).

Choose one of the following options to grant your user permissions:
- [Using the console to assign access](/docs/account?topic=account-account-services#console-acct-mgmt)
- [Using the CLI to assign access](/docs/account?topic=account-account-services#using-the-cli-to-assign-access)
- [Using the API to assign access](/docs/account?topic=account-account-services#api-acct-mgmt). Use the **serviceName** `atracker`.


## Step 2. Configure a COS bucket
{: #getting-started-routing-step2}

Auditing events that are collected in your account are stored in {{site.data.keyword.cos_full_notm}} (COS) buckets. 

When you configure {{site.data.keyword.atracker_short}}, you must define a target per region. The target defines the COS bucket where auditing events in that region are collected.

Before you create a bucket, consider the following information:
- You can create the bucket in any location. 
- You can only configure 1 bucket per target.
- You must not share a bucket to collect [location-based auditing events](/docs/activity-tracker?topic=activity-tracker-event_types#event_types_location) from multiple regions.
- If you have regulatory and compliance requirements, check the locations where you can create a bucket. Then, if performance is critical, consider creating the COS bucket in the same region where the auditing events are generated.

For more information, see [Managing {{site.data.keyword.cos_full_notm}} (COS) buckets](/docs/activity-tracker?topic=activity-tracker-cos).

Use dedicated buckets per region. 
{: important}

Choose one of the following options to create a bucket:

| Action             | More info |
|--------------------|-----------|
| Create a bucket through the {{site.data.keyword.cloud_notm}} UI | [Learn more](/docs/activity-tracker?topic=activity-tracker-cos#cos_create_bucket_ui) |
| Create a bucket through the {{site.data.keyword.cloud_notm}} CLI | [Learn more](/docs/cloud-object-storage?topic=cloud-object-storage-cli-plugin-ic-cos-cli#ic-create-bucket) |
| Create a bucket by using cURL | [Learn more](/docs/cloud-object-storage?topic=cloud-object-storage-curl#curl-add-bucket) |
| Create a bucket by using the REST API | [Learn more](/docs/cloud-object-storage?topic=cloud-object-storage-compatibility-api-bucket-operations#compatibility-api-new-bucket) |
| Create a bucket with a different storage class by using the REST API| [Learn more](/docs/cloud-object-storage?topic=cloud-object-storage-compatibility-api-bucket-operations#compatibility-api-storage-class) |
| Create a bucket with Key Protect or Hyper Protect Crypto Services managed encryption keys (SSE-KP) by using the REST API | [Learn more](/docs/cloud-object-storage?topic=cloud-object-storage-compatibility-api-bucket-operations#compatibility-api-key-protect) |
| Create a bucket by using Terraform | [Learn more](/docs/ibm-cloud-provider-for-terraform?topic=ibm-cloud-provider-for-terraform-object-storage-resources) |
{: caption="Table 1. Create bucket requests" caption-side="top"}


## Step 3. Create a service ID
{: #getting-started-routing-step3}

When {{site.data.keyword.atracker_short}} collects auditing events in your account, it uses an API key to upload data into a bucket. Therefore, you must define credentials in your account to work with the {{site.data.keyword.cos_full_notm}} service. 

To configure a region in your account to collect auditing events and store them in a bucket, you need a service credential with permissions to upload objects into the bucket.

For more information on how to create and grant access to a service ID, see [Granting access to a service ID](/docs/cloud-object-storage?topic=cloud-object-storage-iam-bucket-permissions#iam-service-id).




## Step 4. Define a target
{: #getting-started-routing-step4}

After you create the bucket, you can configure a target in a region. The target defines the COS bucket where auditing events in that region are collected.

Complete the following steps to create a target in the US-South region in your account:

1. Get an access token. 

    You need an IAM access token to authenticate in {{site.data.keyword.cloud_notm}}.

    To generate an IAM access token, run the following command:

    ```text
    export ACCESS_TOKEN=`ibmcloud iam oauth-tokens | grep IAM | cut -d \: -f 2 | sed 's/^ *//'`
    ```
    {: pre}

    The access token is only valid for 1 hour.

2. [Create a target](/docs/activity-tracker?topic=activity-tracker-target#target-create). Run the following cURL command:

    ```shell
    curl -X POST  <ENDPOINT>/api/v1/targets   -H "Authorization:  $ACCESS_TOKEN"   -H "content-type: application/json"   -d '{
        "name": "TARGET_NAME",
        "target_type": "TARGET_TYPE",
        "cos_endpoint": {
          "endpoint": "PRIVATE_COS_ENDPOINT",
          "target_crn": "COS_CRN",
          "bucket": "BUCKET_NAME",
          "api_key": "API_KEY"
        }
      }'
    ```
    {: codeblock}

    Where 

    - `<ENDPOINT>` is the API endpoint in the region where you plan to configure or manage a target. For more information, see [Endpoints](/docs/activity-tracker?topic=activity-tracker-endpoints#endpoints_api).

    - `TARGET_NAME` is the name of the target. The maximum length of the name is 256 characters.

    - `TARGET_TYPE` is the type of the target. The only valid type is `cloud-object-storage`.

    - `cos_endpoint` includes information about the target. For more information on how to get the bucket details, see [Getting the bucket configuration details](/docs/activity-tracker?topic=activity-tracker-cos#cos_bucket_details).

| Field | Description |
|-------|-------------|
| `endpoint` | Indicates the {{site.data.keyword.atracker_short}} where to look for this bucket. Use the private endpoint. |
| `target_crn` | Indicates the [CRN](/docs/account?topic=account-crn) of the COS instance where you provisioned the bucket. |
| `bucket` | Indicates the name of the bucket. |
| `api_key`| Contains the API key that has permissions to upload objects into the bucket. |
{: caption="Table 2. Target endpoint fields" caption-side="top"}

For example, to create a target in the US-South region, you can run the following cURL command:

```shell
curl -X POST   https://private.us-south.atracker.cloud.ibm.com/api/v1/targets   -H "Authorization:  $ACCESS_TOKEN"   -H "content-type: application/json"   -d '{
"name": "My target",
"target_type": "cloud_object_storage",
"cos_endpoint": {
  "endpoint": "s3.private.us-south.cloud-object-storage.appdomain.cloud",
  "target_crn": "crn:v1:bluemix:public:cloud-object-storage:global:a/<AccountID>:<COSinstanceID>::",
  "bucket": "activity-tracking-bucket-us-south",
  "api_key": "xxxxxxxxxxxxx"
  }
}'
```
{: codeblock}

To get the target definition in a region, see [Viewing a target](/docs/activity-tracker?topic=activity-tracker-target#target-view).


## Step 5. Define a route
{: #getting-started-routing-setp5}

After you have configured the target in a region, you must configure the route to specify the rules that define what auditing events are collected in a region and where to store them. 

Auditing events, that are generated in regions where you do not have a target and a route configured, are available through the {{site.data.keyword.at_full_notm}} hosted event search offerings.
{: note}

Complete the following steps to create a route in the US-South region in your account:

1. Get an access token. 

    You need an IAM access token to authenticate in {{site.data.keyword.cloud_notm}}.

    To generate an IAM access token, run the following command:

    ```text
    export ACCESS_TOKEN=`ibmcloud iam oauth-tokens | grep IAM | cut -d \: -f 2 | sed 's/^ *//'`
    ```
    {: pre}

    The access token is only valid for 1 hour.

2. [Create a route](/docs/activity-tracker?topic=activity-tracker-route#route-create). Run the following cURL command:

    ```shell
    curl -X POST  <ENDPOINT>/api/v1/routes   -H "Authorization:  $ACCESS_TOKEN"   -H "content-type: application/json"  -d '{
        "name": "ROUTE_NAME",
        "receive_global_events": true,
        "rules": [
          {
            "target_ids": ["TARGET_ID"]
          }
        ]
      }'
    ```
    {: codeblock}

    Where 

    - `<ENDPOINT>` is the API endpoint in the region where you plan to configure or manage a route. For more information, see [Endpoints](/docs/activity-tracker?topic=activity-tracker-endpoints#endpoints_api).
    
    - `ROUTE_NAME` is the name of the route. The maximum length of the name is 180 characters and cannot include any of the following special characters:`-`, `.`, `_`, `:`.
    
    - `TARGET_ID` is the GUID of the target that defines the bucket where auditing events are routed and collected. 

    - `receive_global_events` indicate the type of events that are collected in the region. When you set `receive_global_events` to true, you are indicating that you want global events and location-based events to go to the target that is configured in the rule that is defined in the route. When you set `receive_global_events` to false, you are indicating that you want location-based events to go to the target that is configured in the rule that is defined in the route.

    For example, you can use the following cURL request to create a route in US- South that defines how global and US-South-location-based events are collected and routed in the account:

    ```shell
    curl -X POST   https://private.us-south.atracker.dev.cloud.ibm.com/api/v1/routes   -H "Authorization:  $ACCESS_TOKEN"   -H "content-type: application/json"  -d '{
        "name": "my-route",
        "receive_global_events": true,
        "rules": [
          {
            "target_ids": ["281f78a2-d83f-430a-905e-e896f03cb403"]
          }
        ]
      }'
     ```
    {: screen}

After a route is configured, the route is enabled after a few minutes.
{: note}

## Step 6. Verify collection of events
{: #getting-started-routing-step6}

After the target and the route is configured, you must verify that auditing events are available in your bucket.

Auditing events are stored in log files in the bucket.

Log files are structured and named as follows:

```text
<REGION>/<DATE>T<HOUR>/2021-02-23T15:38+05.log
```
{: codeblock}

Where

- `<REGION>` defines the region from where auditing events are collected. For example, valid values are `us-south` and `us-east`.
- `<DATE>` defines the date when auditing events are collected. The format is `YYYY-MM-DD`.
- `<HOUR>` defines the hour of the day. The value is set by using a 24-hour clock.
- `<FILENAME>` defines a timestamp. The format is `YYYY-MM-DDTHH:MM+SS`. 

Each log file includes auditing events that have an `eventTime` that maps the filename timestamp. `eventTime` indicates when the auditing event was generated.

For example, a sample log file that collects auditing events in the US-South region looks as follows:

```text
us-south/2021-02-23T15/2021-02-23T15:38+05.log
```
{: screen}


You can choose any of the following methods to list objects in a bucket:
- [List objects in a given bucket by using the CLI](/docs/cloud-object-storage-cli-plugin?topic=cloud-object-storage-cli-plugin-ic-cos-cli#ic-list-objects).
- [List objects in a given bucket by using the API](/docs/cloud-object-storage?topic=cloud-object-storage-compatibility-api-bucket-operations#compatibility-api-list-objects-v2)
- [List objects in a given bucket through the {{site.data.keyword.cloud_notm}} UI](/docs/activity-tracker?topic=activity-tracker-cos#cos_bucket_list_objects_ui).









